<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neural Notes ğŸ§</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; overflow-x:hidden; }
        .container { background:rgba(255,255,255,0.05); backdrop-filter:blur(15px); -webkit-backdrop-filter:blur(15px); border:1px solid rgba(255,255,255,0.1); padding:25px 20px; border-radius:20px; width:100%; max-width:450px; box-shadow:0 15px 35px rgba(0,0,0,0.5); text-align:center; }
        h1 { font-size:26px; margin-bottom:20px; background:linear-gradient(90deg,#00ffcc,#00ffaa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:1px; }
        .search-box { display:flex; gap:8px; margin-bottom:20px; }
        #search-input { flex:1; padding:12px 15px; border:none; outline:none; border-radius:10px; background:rgba(0,0,0,0.3); color:white; font-size:14px; transition:0.3s; border:1px solid transparent; }
        #search-input:focus { border:1px solid #00ffcc; background:rgba(0,0,0,0.5); }
        .action-btn { background:linear-gradient(45deg,#00ffcc,#00ffaa); border:none; padding:12px 15px; border-radius:10px; cursor:pointer; color:#121212; font-weight:bold; transition:transform 0.2s; display:flex; align-items:center; justify-content:center; }
        .action-btn:active { transform:scale(0.95); }
        .mic-btn { background:rgba(0,0,0,0.3); color:white; border:1px solid rgba(255,255,255,0.2); }
        .mic-btn:hover { background:rgba(0,255,204,0.2); border-color:#00ffcc; }
        .recording { animation:pulse 1.5s infinite; background:rgba(255,76,76,0.5)!important; border-color:#ff4c4c!important; }
        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,76,76,0.7)} 70%{box-shadow:0 0 0 10px rgba(255,76,76,0)} 100%{box-shadow:0 0 0 0 rgba(255,76,76,0)} }
        .mode-switch { margin-bottom:15px; }
        #modeBtn { background:transparent; border:1px solid #00ffcc; color:#00ffcc; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:12px; text-transform:uppercase; letter-spacing:1px; transition:0.3s; }
        #modeBtn:hover { background:rgba(0,255,204,0.2); }
        .media-container { margin-bottom:20px; display:flex; justify-content:center; align-items:center; min-height:180px; position:relative; }

        /* Album art always visible as background layer */
        .album-art-wrapper { width:160px; height:160px; border-radius:50%; padding:5px; background:linear-gradient(45deg,#00ffcc,#2c5364); box-shadow:0 0 20px rgba(0,255,204,0.3); display:flex; flex-shrink:0; }
        #album-art { width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid #121212; animation:spin 10s linear infinite; animation-play-state:paused; }
        @keyframes spin { 100%{transform:rotate(360deg)} }

        /* Video container overlays on top in video mode */
        #video-container {
            position:absolute;
            top:0; left:0; right:0; bottom:0;
            width:100%;
            border-radius:12px;
            overflow:hidden;
            display:none;
            box-shadow:0 0 20px rgba(0,0,0,0.6);
            background:#000;
            z-index:10;
        }
        #video-container iframe,
        #yt-player { width:100% !important; height:100% !important; border:none; }

        .now-playing-box { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:20px; padding:0 10px; }
        .now-playing { font-size:16px; font-weight:600; color:#e0e0e0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%; }
        #favBtn { background:none; border:none; font-size:22px; cursor:pointer; transition:transform 0.2s; }
        #favBtn:hover { transform:scale(1.2); }
        .controls { display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:20px; }
        .controls button { background:rgba(255,255,255,0.1); border:none; color:white; font-size:20px; width:50px; height:50px; border-radius:50%; cursor:pointer; transition:0.3s; display:flex; justify-content:center; align-items:center; }
        .controls button:hover { background:rgba(0,255,204,0.2); box-shadow:0 0 15px rgba(0,255,204,0.4); }
        #playPauseBtn { width:65px; height:65px; font-size:24px; background:linear-gradient(45deg,#00ffcc,#00ffaa); color:#121212; }
        .progress-container { display:flex; align-items:center; gap:10px; margin-bottom:20px; font-size:12px; color:#aaa; }
        .progress-bar-wrapper { flex:1; height:8px; background:rgba(255,255,255,0.1); border-radius:5px; cursor:pointer; position:relative; overflow:hidden; }
        .progress-fill { height:100%; width:0%; background:#00ffcc; border-radius:5px; transition:width 0.1s linear; }
        .section-header { text-align:left; font-size:13px; color:#00ffcc; margin:20px 0 10px; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid rgba(0,255,204,0.2); padding-bottom:5px; }
        .list-container { max-height:140px; overflow-y:auto; border-radius:10px; -webkit-overflow-scrolling:touch; }
        .list-container::-webkit-scrollbar { width:6px; }
        .list-container::-webkit-scrollbar-track { background:rgba(0,0,0,0.1); }
        .list-container::-webkit-scrollbar-thumb { background:#00ffcc; border-radius:10px; }
        .list-item { background:rgba(0,0,0,0.3); padding:12px 10px; margin-bottom:8px; border-radius:8px; cursor:pointer; font-size:13px; text-align:left; transition:0.2s; display:flex; align-items:center; justify-content:space-between; }
        .list-item:hover { background:rgba(0,255,204,0.2); transform:translateX(3px); }
        .item-text { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:10px; }
        .action-icon { background:transparent; border:none; cursor:pointer; font-size:16px; padding:5px; border-radius:5px; transition:0.3s; }
        .action-icon.del:hover { background:rgba(255,76,76,0.2); color:#ff4c4c; transform:scale(1.1); }
        #player-status { font-size:11px; color:#888; margin-bottom:8px; min-height:16px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Neural Notes ğŸ¶</h1>

    <div class="search-box">
        <input type="text" id="search-input" placeholder="Search artists, songs..." onkeypress="handleKeyPress(event)">
        <button class="action-btn mic-btn" id="micBtn" onclick="startVoiceSearch()" title="Voice Search">ğŸ¤</button>
        <button class="action-btn" onclick="searchMusic()">ğŸ”</button>
    </div>

    <div class="mode-switch">
        <button id="modeBtn" onclick="toggleMode()">ğŸ¬ Switch to Video</button>
    </div>

    <div class="media-container" id="media-container">
        <div class="album-art-wrapper" id="art-wrapper">
            <img id="album-art" src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500&auto=format&fit=crop" alt="Album Art">
        </div>
        <!-- Video container sits on top as an overlay when active -->
        <div id="video-container">
            <div id="yt-player"></div>
        </div>
    </div>

    <div id="player-status">â³ Loading player...</div>

    <div class="now-playing-box">
        <div class="now-playing" id="now-playing-text">Ready to Play</div>
        <button id="favBtn" onclick="toggleFavorite()" title="Add to Favorites">ğŸ¤</button>
    </div>

    <div class="progress-container">
        <span id="current-time">0:00</span>
        <div class="progress-bar-wrapper" onclick="seekTrack(event)">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <span id="duration">0:00</span>
    </div>

    <div class="controls">
        <button onclick="prevTrack()">â®</button>
        <button id="playPauseBtn" onclick="togglePlayPause()">â–¶</button>
        <button onclick="nextTrack()">â­</button>
    </div>

    <div class="section-header">â¤ï¸ Favorites</div>
    <div id="favorites-list" class="list-container"></div>

    <div class="section-header">ğŸ” Search Results</div>
    <div id="music-results" class="list-container"></div>

    <div class="section-header">ğŸ•’ Recently Played</div>
    <div id="search-history" class="list-container"></div>
</div>

<script>
    const API_KEY = 'AIzaSyAhO7y4jNGufzxdeK4lpap-Oolr1aS_DJo';
    let player = null;
    let isPlayerReady = false;
    let pendingPlay = null;
    let pendingAutoLoad = null;

    let searchResults = JSON.parse(localStorage.getItem('neonSearchResults')) || [];
    let playedSongs   = JSON.parse(localStorage.getItem('neonHistory'))       || [];
    let favorites     = JSON.parse(localStorage.getItem('neonFavorites'))     || [];

    let historyIndex = playedSongs.length > 0 ? playedSongs.length - 1 : -1;
    let isVideoMode  = false;
    let progressInterval;
    let currentTrack = null;

    window.onload = () => {
        renderResultsUI();
        updateHistoryUI();
        renderFavoritesUI();

        if (playedSongs.length > 0) {
            currentTrack = playedSongs[playedSongs.length - 1];
            updateUI(currentTrack.title, currentTrack.thumbnail);
            checkFavoriteStatus();
            pendingAutoLoad = currentTrack;
        }

        // Load YouTube IFrame API with nocookie host to suppress ads
        loadYTScript();
    };

    // â”€â”€â”€ Load YT API using nocookie domain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadYTScript() {
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        document.head.appendChild(tag);
    }

    // â”€â”€â”€ YOUTUBE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '100%',
            width:  '100%',
            // host: nocookie suppresses ads for most users
            host: 'https://www.youtube-nocookie.com',
            playerVars: {
                controls:       0,
                disablekb:      1,
                fs:             0,
                rel:            0,
                playsinline:    1,
                iv_load_policy: 3,   // hide annotations
                modestbranding: 1,   // minimal YT branding
                origin:         window.location.origin || 'https://localhost'
            },
            events: {
                onReady:       onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError:       onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        isPlayerReady = true;
        event.target.setVolume(100);
        setStatus('');

        if (pendingPlay) {
            const t = pendingPlay;
            pendingPlay = null;
            pendingAutoLoad = null;
            _loadAndPlay(t.videoId, t.title, t.thumbnail);
        } else if (pendingAutoLoad) {
            player.cueVideoById(pendingAutoLoad.videoId);
            pendingAutoLoad = null;
        }
    }

    function onPlayerError(event) {
        console.error('YT Error:', event.data);
        setStatus('âš ï¸ Video unavailable, skippingâ€¦');
        nextTrack();
    }

    function onPlayerStateChange(event) {
        const art = document.getElementById('album-art');
        const btn = document.getElementById('playPauseBtn');

        if (event.data === YT.PlayerState.PLAYING) {
            btn.innerText = 'â¸';
            art.style.animationPlayState = 'running';
            startProgressBar();
            setStatus('');
        } else if (event.data === YT.PlayerState.PAUSED) {
            btn.innerText = 'â–¶';
            art.style.animationPlayState = 'paused';
            clearInterval(progressInterval);
        } else if (event.data === YT.PlayerState.BUFFERING) {
            btn.innerText = 'â³';
        } else if (event.data === YT.PlayerState.ENDED) {
            btn.innerText = 'â–¶';
            art.style.animationPlayState = 'paused';
            clearInterval(progressInterval);
            nextTrack();
        }
    }

    // â”€â”€â”€ CORE PLAY LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function playMusic(videoId, title, thumbnail) {
        if (!isPlayerReady || !player) {
            pendingPlay = { videoId, title, thumbnail };
            setStatus('â³ Player loading, starting soonâ€¦');
            currentTrack = pendingPlay;
            updateUI(title, thumbnail);
            checkFavoriteStatus();
            return;
        }
        _loadAndPlay(videoId, title, thumbnail);
    }

    function _loadAndPlay(videoId, title, thumbnail) {
        currentTrack = { videoId, title, thumbnail };

        // loadVideoById always restarts and plays â€” works in both audio & video mode
        player.loadVideoById(videoId);

        updateUI(title, thumbnail);
        checkFavoriteStatus();
        setStatus('');

        // History dedup
        if (!playedSongs.length || playedSongs[playedSongs.length - 1].videoId !== videoId) {
            playedSongs.push(currentTrack);
            if (playedSongs.length > 20) playedSongs.shift();
            localStorage.setItem('neonHistory', JSON.stringify(playedSongs));
        }
        historyIndex = playedSongs.findIndex(s => s.videoId === videoId);
        if (historyIndex === -1) historyIndex = playedSongs.length - 1;

        updateHistoryUI();
        setupMediaSession(title, thumbnail);
    }

    // â”€â”€â”€ PLAY / PAUSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function togglePlayPause() {
        if (!isPlayerReady || !player) return;

        const state = player.getPlayerState();

        if (state === YT.PlayerState.PLAYING) {
            player.pauseVideo();
            return;
        }

        if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.CUED) {
            player.playVideo();
            return;
        }

        if (currentTrack) {
            player.loadVideoById(currentTrack.videoId);
            return;
        }

        if (playedSongs.length > 0) {
            const s = playedSongs[playedSongs.length - 1];
            _loadAndPlay(s.videoId, s.title, s.thumbnail);
        }
    }

    // â”€â”€â”€ PREV / NEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function nextTrack() {
        if (historyIndex < playedSongs.length - 1) {
            historyIndex++;
            const s = playedSongs[historyIndex];
            playMusic(s.videoId, s.title, s.thumbnail);
        }
    }

    function prevTrack() {
        if (historyIndex > 0) {
            historyIndex--;
            const s = playedSongs[historyIndex];
            playMusic(s.videoId, s.title, s.thumbnail);
        }
    }

    // â”€â”€â”€ MODE SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    /**
     * FIX: Instead of hiding/showing the player iframe (which destroys its state),
     * we keep the iframe alive at all times. In audio mode we just cover it with the
     * album art. When switching to video we reveal the iframe and seek to the current
     * playback position so the video is in sync.
     */
    function toggleMode() {
        isVideoMode = !isVideoMode;

        const videoContainer = document.getElementById('video-container');
        const artWrapper     = document.getElementById('art-wrapper');
        const modeBtn        = document.getElementById('modeBtn');

        if (isVideoMode) {
            modeBtn.innerText = 'ğŸ§ Switch to Audio';
            videoContainer.style.display = 'block';
            // Sync video to current audio position
            if (isPlayerReady && player && player.getCurrentTime) {
                const currentTime = player.getCurrentTime();
                const state = player.getPlayerState();
                if (currentTrack) {
                    if (state === YT.PlayerState.PLAYING) {
                        // Already playing â€” seekTo syncs the visible video
                        player.seekTo(currentTime, true);
                    } else if (state === YT.PlayerState.PAUSED) {
                        player.seekTo(currentTime, true);
                    }
                }
            }
        } else {
            modeBtn.innerText = 'ğŸ¬ Switch to Video';
            videoContainer.style.display = 'none';
        }
    }

    // â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function handleKeyPress(e) { if (e.key === 'Enter') searchMusic(); }

    function searchMusic() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;

        document.getElementById('music-results').innerHTML = '<div style="color:#00ffcc;padding:10px;">Searchingâ€¦</div>';

        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(query)}&key=${API_KEY}`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!data.items) throw new Error('No items');
                searchResults = data.items.map(item => ({
                    videoId:   item.id.videoId,
                    title:     item.snippet.title,
                    thumbnail: item.snippet.thumbnails.high.url
                }));
                localStorage.setItem('neonSearchResults', JSON.stringify(searchResults));
                renderResultsUI();
            })
            .catch(() => {
                document.getElementById('music-results').innerHTML = '<div style="color:#ff4c4c;padding:10px;">Search failed. Check connection or API key.</div>';
            });
    }

    // â”€â”€â”€ VOICE SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function startVoiceSearch() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert('Voice search not supported in this browser.'); return; }
        const rec = new SR();
        const mic = document.getElementById('micBtn');
        rec.onstart  = () => mic.classList.add('recording');
        rec.onend    = () => mic.classList.remove('recording');
        rec.onresult = e => {
            document.getElementById('search-input').value = e.results[0][0].transcript;
            searchMusic();
        };
        rec.start();
    }

    // â”€â”€â”€ FAVORITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function checkFavoriteStatus() {
        if (!currentTrack) return;
        const isFav = favorites.some(f => f.videoId === currentTrack.videoId);
        document.getElementById('favBtn').innerText = isFav ? 'â¤ï¸' : 'ğŸ¤';
    }

    function toggleFavorite() {
        if (!currentTrack) return;
        const idx = favorites.findIndex(f => f.videoId === currentTrack.videoId);
        if (idx > -1) favorites.splice(idx, 1); else favorites.push(currentTrack);
        localStorage.setItem('neonFavorites', JSON.stringify(favorites));
        checkFavoriteStatus();
        renderFavoritesUI();
    }

    function renderFavoritesUI() {
        const c = document.getElementById('favorites-list');
        c.innerHTML = '';
        if (!favorites.length) { c.innerHTML = '<div style="color:#888;font-size:12px;padding:10px;">No favorites yet.</div>'; return; }
        favorites.forEach((item, i) => {
            const div = createListItem(`â¤ï¸ ${item.title}`, () => playMusic(item.videoId, item.title, item.thumbnail));
            div.appendChild(createDelBtn(e => {
                e.stopPropagation();
                favorites.splice(i, 1);
                localStorage.setItem('neonFavorites', JSON.stringify(favorites));
                renderFavoritesUI();
                checkFavoriteStatus();
            }));
            c.appendChild(div);
        });
    }

    // â”€â”€â”€ RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderResultsUI() {
        const c = document.getElementById('music-results');
        c.innerHTML = '';
        searchResults.forEach((item, i) => {
            const div = createListItem(`ğŸµ ${item.title}`, () => playMusic(item.videoId, item.title, item.thumbnail));
            div.appendChild(createDelBtn(e => {
                e.stopPropagation();
                searchResults.splice(i, 1);
                localStorage.setItem('neonSearchResults', JSON.stringify(searchResults));
                renderResultsUI();
            }));
            c.appendChild(div);
        });
    }

    // â”€â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function updateHistoryUI() {
        const c = document.getElementById('search-history');
        c.innerHTML = '';
        if (!playedSongs.length) return;
        [...playedSongs].reverse().forEach((item, i) => {
            const actualIdx = playedSongs.length - 1 - i;
            const div = createListItem(`ğŸ•’ ${item.title}`, () => playMusic(item.videoId, item.title, item.thumbnail));
            div.appendChild(createDelBtn(e => {
                e.stopPropagation();
                playedSongs.splice(actualIdx, 1);
                localStorage.setItem('neonHistory', JSON.stringify(playedSongs));
                if (actualIdx < historyIndex) historyIndex--;
                else if (actualIdx === historyIndex) historyIndex = Math.max(0, historyIndex - 1);
                updateHistoryUI();
            }));
            c.appendChild(div);
        });
    }

    // â”€â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function startProgressBar() {
        clearInterval(progressInterval);
        const fill = document.getElementById('progress-fill');
        const cur  = document.getElementById('current-time');
        const dur  = document.getElementById('duration');
        progressInterval = setInterval(() => {
            if (!isPlayerReady || !player?.getCurrentTime) return;
            const c = player.getCurrentTime();
            const d = player.getDuration();
            if (d > 0) {
                fill.style.width = `${(c / d) * 100}%`;
                cur.textContent  = formatTime(c);
                dur.textContent  = formatTime(d);
            }
        }, 500);
    }

    function seekTrack(e) {
        if (!isPlayerReady || !player?.getDuration) return;
        const rect = document.querySelector('.progress-bar-wrapper').getBoundingClientRect();
        const ratio = (e.clientX - rect.left) / rect.width;
        const seekTo = Math.max(0, Math.min(1, ratio)) * player.getDuration();
        player.seekTo(seekTo, true);
    }

    function formatTime(s) {
        const m = Math.floor(s / 60), sec = Math.floor(s % 60);
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // â”€â”€â”€ MEDIA SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function setupMediaSession(title, thumbnail) {
        if (!('mediaSession' in navigator)) return;
        navigator.mediaSession.metadata = new MediaMetadata({
            title, artist: 'Neural Notes',
            artwork: [{ src: thumbnail, sizes: '512x512', type: 'image/jpeg' }]
        });
        navigator.mediaSession.setActionHandler('play',          () => player.playVideo());
        navigator.mediaSession.setActionHandler('pause',         () => player.pauseVideo());
        navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
        navigator.mediaSession.setActionHandler('nexttrack',     nextTrack);
    }

    // â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function updateUI(title, thumbnail) {
        document.getElementById('now-playing-text').innerText = title;
        document.getElementById('album-art').src = thumbnail;
    }

    function setStatus(msg) {
        document.getElementById('player-status').textContent = msg;
    }

    function createListItem(text, onClick) {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.onclick = onClick;
        const span = document.createElement('span');
        span.className = 'item-text';
        span.innerHTML = text;
        div.appendChild(span);
        return div;
    }

    function createDelBtn(onClick) {
        const btn = document.createElement('button');
        btn.className = 'action-icon del';
        btn.innerHTML = 'âœ–';
        btn.title = 'Remove';
        btn.onclick = onClick;
        return btn;
    }
</script>
</body>
</html>
