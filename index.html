<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neural Notes üéß</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:linear-gradient(135deg,#0f2027,#203a43,#2c5364); color:#fff; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; overflow-x:hidden; }
        .container { background:rgba(255,255,255,0.05); backdrop-filter:blur(15px); -webkit-backdrop-filter:blur(15px); border:1px solid rgba(255,255,255,0.1); padding:25px 20px; border-radius:20px; width:100%; max-width:450px; box-shadow:0 15px 35px rgba(0,0,0,0.5); text-align:center; }
        h1 { font-size:26px; margin-bottom:20px; background:linear-gradient(90deg,#00ffcc,#00ffaa); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:1px; }
        
        /* Search */
        .search-box { display:flex; gap:8px; margin-bottom:20px; }
        #search-input { flex:1; padding:12px 15px; border:none; outline:none; border-radius:10px; background:rgba(0,0,0,0.3); color:white; font-size:14px; transition:0.3s; border:1px solid transparent; }
        #search-input:focus { border:1px solid #00ffcc; background:rgba(0,0,0,0.5); }
        .action-btn { background:linear-gradient(45deg,#00ffcc,#00ffaa); border:none; padding:12px 15px; border-radius:10px; cursor:pointer; color:#121212; font-weight:bold; transition:transform 0.2s; display:flex; align-items:center; justify-content:center; }
        .action-btn:active { transform:scale(0.95); }
        .mic-btn { background:rgba(0,0,0,0.3); color:white; border:1px solid rgba(255,255,255,0.2); }
        .mic-btn:hover { background:rgba(0,255,204,0.2); border-color:#00ffcc; }
        .recording { animation:pulse 1.5s infinite; background:rgba(255,76,76,0.5)!important; border-color:#ff4c4c!important; }
        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(255,76,76,0.7)} 70%{box-shadow:0 0 0 10px rgba(255,76,76,0)} 100%{box-shadow:0 0 0 0 rgba(255,76,76,0)} }
        
        /* Mode Switch */
        .mode-switch { margin-bottom:15px; }
        #modeBtn { background:transparent; border:1px solid #00ffcc; color:#00ffcc; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:12px; text-transform:uppercase; letter-spacing:1px; transition:0.3s; }
        #modeBtn:hover { background:rgba(0,255,204,0.2); }
        
        /* Media Container */
        .media-container { margin-bottom:20px; display:flex; justify-content:center; align-items:center; min-height:180px; position:relative; }
        .album-art-wrapper { width:160px; height:160px; border-radius:50%; padding:5px; background:linear-gradient(45deg,#00ffcc,#2c5364); box-shadow:0 0 20px rgba(0,255,204,0.3); display:flex; }
        #album-art { width:100%; height:100%; border-radius:50%; object-fit:cover; border:3px solid #121212; animation:spin 10s linear infinite; animation-play-state:paused; }
        @keyframes spin { 100%{transform:rotate(360deg)} }
        
        /* Video Container Fixes */
        #video-container { 
            width:100%; aspect-ratio:16/9; border-radius:12px; overflow:hidden; 
            box-shadow:0 0 20px rgba(0,0,0,0.6); background:#000;
            position:absolute; visibility:hidden; opacity:0; pointer-events:none; 
            transition:opacity 0.3s ease; 
        }
        #video-container.video-active {
            position:relative; visibility:visible; opacity:1; pointer-events:auto;
        }

        /* Controls & Now Playing */
        .now-playing-box { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:20px; padding:0 10px; }
        .now-playing { font-size:16px; font-weight:600; color:#e0e0e0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%; }
        #favBtn { background:none; border:none; font-size:22px; cursor:pointer; transition:transform 0.2s; }
        #favBtn:hover { transform:scale(1.2); }
        .controls { display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:20px; }
        .controls button { background:rgba(255,255,255,0.1); border:none; color:white; font-size:20px; width:50px; height:50px; border-radius:50%; cursor:pointer; transition:0.3s; display:flex; justify-content:center; align-items:center; }
        .controls button:hover { background:rgba(0,255,204,0.2); box-shadow:0 0 15px rgba(0,255,204,0.4); }
        #playPauseBtn { width:65px; height:65px; font-size:24px; background:linear-gradient(45deg,#00ffcc,#00ffaa); color:#121212; }
        
        /* Progress Bar */
        .progress-container { display:flex; align-items:center; gap:10px; margin-bottom:20px; font-size:12px; color:#aaa; }
        .progress-bar-wrapper { flex:1; height:8px; background:rgba(255,255,255,0.1); border-radius:5px; cursor:pointer; position:relative; overflow:hidden; }
        .progress-fill { height:100%; width:0%; background:#00ffcc; border-radius:5px; transition:width 0.1s linear; }
        
        /* Lists */
        .section-header { text-align:left; font-size:13px; color:#00ffcc; margin:20px 0 10px; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid rgba(0,255,204,0.2); padding-bottom:5px; }
        .list-container { max-height:140px; overflow-y:auto; border-radius:10px; -webkit-overflow-scrolling:touch; }
        .list-container::-webkit-scrollbar { width:6px; }
        .list-container::-webkit-scrollbar-track { background:rgba(0,0,0,0.1); }
        .list-container::-webkit-scrollbar-thumb { background:#00ffcc; border-radius:10px; }
        .list-item { background:rgba(0,0,0,0.3); padding:12px 10px; margin-bottom:8px; border-radius:8px; cursor:pointer; font-size:13px; text-align:left; transition:0.2s; display:flex; align-items:center; justify-content:space-between; }
        .list-item:hover { background:rgba(0,255,204,0.2); transform:translateX(3px); }
        .item-text { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding-right:10px; }
        .action-icon { background:transparent; border:none; cursor:pointer; font-size:16px; padding:5px; border-radius:5px; transition:0.3s; }
        .action-icon.del:hover { background:rgba(255,76,76,0.2); color:#ff4c4c; transform:scale(1.1); }
        #player-status { font-size:11px; color:#888; margin-bottom:8px; min-height:16px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Neural Notes üé∂</h1>

    <div class="search-box">
        <input type="text" id="search-input" placeholder="Search artists, songs..." onkeypress="handleKeyPress(event)">
        <button class="action-btn mic-btn" id="micBtn" onclick="startVoiceSearch()" title="Voice Search">üé§</button>
        <button class="action-btn" onclick="searchMusic()">üîç</button>
    </div>

    <div class="mode-switch">
        <button id="modeBtn" onclick="toggleMode()">üé¨ Switch to Video</button>
    </div>

    <div class="media-container">
        <div class="album-art-wrapper" id="art-wrapper">
            <img id="album-art" src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=500&auto=format&fit=crop" alt="Album Art">
        </div>
        <div id="video-container">
            <div id="yt-player"></div>
        </div>
    </div>

    <div id="player-status">‚è≥ Loading player...</div>

    <div class="now-playing-box">
        <div class="now-playing" id="now-playing-text">Ready to Play</div>
        <button id="favBtn" onclick="toggleFavorite()" title="Add to Favorites">ü§ç</button>
    </div>

    <div class="progress-container">
        <span id="current-time">0:00</span>
        <div class="progress-bar-wrapper" onclick="seekTrack(event)">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <span id="duration">0:00</span>
    </div>

    <div class="controls">
        <button onclick="prevTrack()">‚èÆ</button>
        <button id="playPauseBtn" onclick="togglePlayPause()">‚ñ∂</button>
        <button onclick="nextTrack()">‚è≠</button>
    </div>

    <div class="section-header">‚ù§Ô∏è Favorites</div>
    <div id="favorites-list" class="list-container"></div>

    <div class="section-header">üîç Search Results</div>
    <div id="music-results" class="list-container"></div>

    <div class="section-header">üïí Recently Played</div>
    <div id="search-history" class="list-container"></div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
    const API_KEY = 'AIzaSyAhO7y4jNGufzxdeK4lpap-Oolr1aS_DJo';
    let player = null;
    let isPlayerReady = false;

    let pendingPlay = null;   
    let pendingAutoLoad = null; 

    let searchResults = JSON.parse(localStorage.getItem('neonSearchResults')) || [];
    let playedSongs   = JSON.parse(localStorage.getItem('neonHistory'))       || [];
    let favorites     = JSON.parse(localStorage.getItem('neonFavorites'))     || [];

    let historyIndex = playedSongs.length > 0 ? playedSongs.length - 1 : -1;
    let isVideoMode  = false;
    let progressInterval;
    let currentTrack = null;

    window.onload = () => {
        renderResultsUI();
        updateHistoryUI();
        renderFavoritesUI();

        if (playedSongs.length > 0) {
            currentTrack = playedSongs[playedSongs.length - 1];
            updateUI(currentTrack.title, currentTrack.thumbnail);
            checkFavoriteStatus();
            pendingAutoLoad = currentTrack;
        }
    };

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '100%',
            width:  '100%',
            playerVars: { controls: 0, disablekb: 1, fs: 0, rel: 0, playsinline: 1 },
            events: {
                onReady:       onPlayerReady,
                onStateChange: onPlayerStateChange,
                onError:       onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        isPlayerReady = true;
        event.target.setVolume(100);
        setStatus('');

        if (pendingPlay) {
            const t = pendingPlay;
            pendingPlay = null;
            pendingAutoLoad = null;
            _loadAndPlay(t.videoId, t.title, t.thumbnail);
        } else if (pendingAutoLoad) {
            player.cueVideoById(pendingAutoLoad.videoId);
            pendingAutoLoad = null;
        }
    }

    function onPlayerError(event) {
        console.error('YT Error:', event.data);
        setStatus('‚ö†Ô∏è Video unavailable, skipping‚Ä¶');
        nextTrack();
    }

    function onPlayerStateChange(event) {
        const art = document.getElementById('album-art');
        const btn = document.getElementById('playPauseBtn');

        if (event.data === YT.PlayerState.PLAYING) {
            btn.innerText = '‚è∏';
            art.style.animationPlayState = 'running';
            startProgressBar();
            setStatus('');
        } else if (event.data === YT.PlayerState.PAUSED) {
            btn.innerText = '‚ñ∂';
            art.style.animationPlayState = 'paused';
            clearInterval(progressInterval);
        } else if (event.data === YT.PlayerState.BUFFERING) {
            btn.innerText = '‚è≥';
        } else if (event.data === YT.PlayerState.ENDED) {
            btn.innerText = '‚ñ∂';
            art.style.animationPlayState = 'paused';
            clearInterval(progressInterval);
            nextTrack();
        }
    }

    function playMusic(videoId, title, thumbnail) {
        if (!isPlayerReady || !player) {
            pendingPlay = { videoId, title, thumbnail };
            setStatus('‚è≥ Player loading, starting soon‚Ä¶');
            currentTrack = pendingPlay;
            updateUI(title, thumbnail);
            checkFavoriteStatus();
            return;
        }
        _loadAndPlay(videoId, title, thumbnail);
    }

    function _loadAndPlay(videoId, title, thumbnail) {
        currentTrack = { videoId, title, thumbnail };
        player.loadVideoById(videoId);   
        updateUI(title, thumbnail);
        checkFavoriteStatus();
        setStatus('');

        if (playedSongs.length === 0 || playedSongs[playedSongs.length - 1].videoId !== videoId) {
            playedSongs.push(currentTrack);
            if (playedSongs.length > 20) playedSongs.shift();
            localStorage.setItem('neonHistory', JSON.stringify(playedSongs));
        }
        historyIndex = playedSongs.findIndex(s => s.videoId === videoId);
        if (historyIndex === -1) historyIndex = playedSongs.length - 1;

        updateHistoryUI();
        setupMediaSession(title, thumbnail);
    }

    function togglePlayPause() {
        if (!isPlayerReady || !player) return;

        const state = player.getPlayerState();

        if (state === YT.PlayerState.PLAYING) {
            player.pauseVideo();
            return;
        }

        if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.CUED) {
            player.playVideo();
            return;
        }

        if (currentTrack) {
            player.loadVideoById(currentTrack.videoId);
            return;
        }

        if (playedSongs.length > 0) {
            const s = playedSongs[playedSongs.length - 1];
            _loadAndPlay(s.videoId, s.title, s.thumbnail);
        }
    }

    function nextTrack() {
        if (historyIndex < playedSongs.length - 1) {
            historyIndex++;
            const s = playedSongs[historyIndex];
            playMusic(s.videoId, s.title, s.thumbnail);
        }
    }

    function prevTrack() {
        if (historyIndex > 0) {
            historyIndex--;
            const s = playedSongs[historyIndex];
            playMusic(s.videoId, s.title, s.thumbnail);
        }
    }

    function handleKeyPress(e) { if (e.key === 'Enter') searchMusic(); }

    function searchMusic() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;

        document.getElementById('music-results').innerHTML = '<div style="color:#00ffcc;padding:10px;">Searching‚Ä¶</div>';

        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=10&q=${encodeURIComponent(query)}&key=${API_KEY}`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!data.items) throw new Error('No items');
                searchResults = data.items.map(item => ({
                    videoId:   item.id.videoId,
                    title:     item.snippet.title,
                    thumbnail: item.snippet.thumbnails.high.url
                }));
                localStorage.setItem('neonSearchResults', JSON.stringify(searchResults));
                renderResultsUI();
            })
            .catch(() => {
                document.getElementById('music-results').innerHTML = '<div style="color:#ff4c4c;padding:10px;">Search failed. Check connection or API key.</div>';
            });
    }

    function startVoiceSearch() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { alert('Voice search not supported in this browser.'); return; }
        const rec = new SR();
        const mic = document.getElementById('micBtn');
        rec.onstart  = () => mic.classList.add('recording');
        rec.onend    = () => mic.classList.remove('recording');
        rec.onresult = e => {
            document.getElementById('search-input').value = e.results[0][0].transcript;
            searchMusic();
        };
        rec.start();
    }

    function toggleMode() {
        isVideoMode = !isVideoMode;
        document.getElementById('modeBtn').innerText = isVideoMode ? 'üéß Switch to Audio' : 'üé¨ Switch to Video';
        document.getElementById('art-wrapper').style.display = isVideoMode ? 'none' : 'flex';
        
        const videoContainer = document.getElementById('video-container');
        if (isVideoMode) {
            videoContainer.classList.add('video-active');
        } else {
            videoContainer.classList.remove('video-active');
        }
    }

    function checkFavoriteStatus() {
        if (!currentTrack) return;
        const isFav = favorites.some(f => f.videoId === currentTrack.videoId);
        document.getElementById('favBtn').innerText = isFav ? '‚ù§Ô∏è' : 'ü§ç';
    }

    function toggleFavorite() {
        if (!currentTrack) return;
        const idx = favorites.findIndex(f => f.videoId === currentTrack.videoId);
        if (idx > -1) favorites.splice(idx, 1); else favorites.push(currentTrack);
        localStorage.setItem('neonFavorites', JSON.stringify(favorites));
        checkFavoriteStatus();
        renderFavoritesUI();
    }

    function renderFavoritesUI() {
        const c = document.getElementById('favorites-list');
        c.innerHTML = '';
        if (!favorites.length) { c.innerHTML = '<div style="color:#888;font-size:12px;padding:10px;">No favorites yet.</div>'; return; }
        favorites.forEach((item, i) => {
            const div = createListItem(`‚ù§Ô∏è ${item.title}`, () => playMusic(item.videoId, item.title, item.thumbnail));
            div.appendChild(createDelBtn(e => {
                e.stopPropagation();
                favorites.splice(i, 1);
                localStorage.setItem('neonFavorites', JSON.stringify(favorites));
                renderFavoritesUI();
                checkFavoriteStatus();
            }));
            c.appendChild(div);
        });
    }

    function renderResultsUI() {
        const c = document.getElementById('music-results');
        c.innerHTML = '';
        searchResults.forEach((item, i) => {
            const div = createListItem(`üéµ ${item.title}`, () => playMusic(item.videoId, item.title, item.thumbnail));
            div.appendChild(createDelBtn(e => {
                e.stopPropagation();
                searchResults.splice(i, 1);
                localStorage.setItem('neonSearchResults', JSON.stringify(searchResults));
                renderResultsUI();
            }));
            c.appendChild(div);
        });
    }

    function updateHistoryUI() {
        const c = document.getElementById('search-history');
        c.innerHTML = '';
        if (!playedSongs.length) return;
        [...playedSongs].reverse().forEach((item, i) => {
            const actualIdx = playedSongs.length - 1 - i;
            const div = createListItem(`üïí ${item.title}`, () => playMusic(item.videoId, item.title, item.thumbnail));
            div.appendChild(createDelBtn(e => {
                e.stopPropagation();
                playedSongs.splice(actualIdx, 1);
                localStorage.setItem('neonHistory', JSON.stringify(playedSongs));
                if (actualIdx < historyIndex) historyIndex--;
                else if (actualIdx === historyIndex) historyIndex = Math.max(0, historyIndex - 1);
                updateHistoryUI();
            }));
            c.appendChild(div);
        });
    }

    function startProgressBar() {
        clearInterval(progressInterval);
        const fill = document.getElementById('progress-fill');
        const cur  = document.getElementById('current-time');
        const dur  = document.getElementById('duration');
        progressInterval = setInterval(() => {
            if (!isPlayerReady || !player?.getCurrentTime) return;
            const c = player.getCurrentTime();
            const d = player.getDuration();
            if (d > 0) {
                fill.style.width = `${(c / d) * 100}%`;
                cur.textContent  = formatTime(c);
                dur.textContent  = formatTime(d);
            }
        }, 500);
    }

    function seekTrack(e) {
        if (!isPlayerReady || !player?.getDuration) return;
        const w = document.querySelector('.progress-bar-wrapper').clientWidth;
        player.seekTo((e.offsetX / w) * player.getDuration());
    }

    function formatTime(s) {
        const m = Math.floor(s / 60), sec = Math.floor(s % 60);
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    }

    function setupMediaSession(title, thumbnail) {
        if (!('mediaSession' in navigator)) return;
        navigator.mediaSession.metadata = new MediaMetadata({
            title, artist: 'Neural Notes',
            artwork: [{ src: thumbnail, sizes: '512x512', type: 'image/jpeg' }]
        });
        navigator.mediaSession.setActionHandler('play',          () => player.playVideo());
        navigator.mediaSession.setActionHandler('pause',         () => player.pauseVideo());
        navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
        navigator.mediaSession.setActionHandler('nexttrack',     nextTrack);
    }

    function updateUI(title, thumbnail) {
        document.getElementById('now-playing-text').innerText = title;
        document.getElementById('album-art').src = thumbnail;
    }

    function setStatus(msg) {
        document.getElementById('player-status').textContent = msg;
    }

    function createListItem(text, onClick) {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.onclick = onClick;
        const span = document.createElement('span');
        span.className = 'item-text';
        span.innerHTML = text;
        div.appendChild(span);
        return div;
    }

    function createDelBtn(onClick) {
        const btn = document.createElement('button');
        btn.className = 'action-icon del';
        btn.innerHTML = '‚úñ';
        btn.title = 'Remove';
        btn.onclick = onClick;
        return btn;
    }
</script>
</body>
</html>

